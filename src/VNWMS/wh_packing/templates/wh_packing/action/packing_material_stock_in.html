{% extends 'wh_packing/bases/base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load i18n %}
{% block title %} {% trans "Stock In" %} {% endblock %}
{% block link %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}
{% block base_js %}
    <style>
        .jsgrid-button.jsgrid-mode-button.jsgrid-insert-mode-button {
            display: none !important;
        }

        .jsgrid-grid-body::-webkit-scrollbar {
            height: 16px !important;
        }

        .input-custom {
            --bs-gutter-x: 0;
        }

        h3, th {
            text-align: center;
        }

        .jsgrid-cell {
            white-space: nowrap;      /* Kh√¥ng cho xu·ªëng d√≤ng */
            overflow: hidden;         /* ·∫®n ph·∫ßn n·ªôi dung v∆∞·ª£t qu√° */
            text-overflow: ellipsis;  /* Hi·ªÉn th·ªã d·∫•u "..." n·∫øu b·ªã c·∫Øt */
            max-width: 100%;          /* ƒê·∫£m b·∫£o n·ªôi dung kh√¥ng v∆∞·ª£t qu√° √¥ */
        }

        input[type="checkbox"] {
            display: flex;
            align-items: center;
            width: 35px;
            height: 22px;
            transform: scale(1.5);
        }

        body {
            font-size: 0.875rem;
        }

    </style>
{% endblock %}

{% block jquery %} {% endblock %}

{% block content %}
    <div class="row p-3">
        <div class="col-1"></div>
        <div class="col-10">
            <h3 class="col p-3">{% trans "Warehouse Stock In Form" %}</h3>

            <form id="myForm">
                {% crispy form %}
                <button id="deleteSelected" class="btn btn-sm btn-danger mb-1" type="button">
                    üóëÔ∏è {% trans "Clear" %}
                </button>
                <div id="jsGrid"></div>
                    <div id="numberPicker" style="display:none; position:fixed; top:20%; left:30%; width:300px; padding:20px; background:#fff; border:1px solid #ccc; box-shadow:0 2px 10px rgba(0,0,0,0.2);">
                    <h3>{% trans "Choose Location" %}</h3>
                    {% for bin in bins %}
                    <button class="number-btn" data-value="{{ bin.bin_id }}" style="
                            {% if bin.has_stock %}
                                background-color: #d2e8b9
                            {% else %};
                                background-color: #fff
                            {% endif %}">
                        {{ bin.bin_id }}
                    </button>
                    {% endfor %}
                    <br><br>
                    <button id="closePicker">{% trans "Close" %}</button>
                </div>

                <hr />
                <div style="text-align: center" class="p-3">
                    <button id="postDataButton" class="btn btn-info btn-lg">{% trans "Post" %}</button>
                </div>
            </form>

            <div class="col-1"></div>
        </div>
    </div>
{% endblock %}

{% block script %}
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
{% endblock %}

{% block javascript %}

    <script>
        $(document).ready(function() {

            function openMapPage(warehouse_id, obj) {

                let childWindow = window.open('{% url 'warehouse_map' warehouse_code %}', "Warehouse Map", "width=1400,height=800");

                // Áõ£ËÅΩ‰æÜËá™Â≠êÈ†ÅÈù¢ÁöÑÂõûÂÇ≥Êï∏Êìö
                window.addEventListener("message", function(event) {
                    if (event.origin !== window.location.origin) {
                        return;  // Á¢∫‰øùÂÆâÂÖ®ÊÄßÔºåÂè™Êé•ÂèóÂêåÊ∫êÁöÑÊ∂àÊÅØ
                    }

                    obj.val(event.data);
                    obj.focus();
                }, false);

            }


            $(".select2-bin").select2({
                width: "100%"
            });

            $('.select2-selection.select2-selection--single').css({
                'height': '38px',
            });

            $('#select2-id_order_bin-container').css({
                'margin-top': '4px',
                'margin-left': '5px'
            });

            const translations = {
                comment: "{% trans 'Comment' %}",
                productOrder: "{% trans 'Product Order' %}",
                purchaseNo: "{% trans 'Purchase No' %}",
                versionNo: "{% trans 'Version No' %}",
                versionSeq: "{% trans 'Version Seq' %}",
                size: "{% trans 'Size' %}",
                lotNo: "{% trans 'Lot No' %}",
                purchaseQty: "{% trans 'Purchase Qty' %}",
                purchaseUnit: "{% trans 'Purchase Unit' %}",
                itemType: "{% trans 'Item Type' %}",
                postDate: "{% trans 'Post Date' %}",
                supplier: "{% trans 'Supplier' %}",
                customerNo: "{% trans 'Customer' %}",
                sapMtrNo: "{% trans 'Mtr No' %}",
                qty: "{% trans 'Qty' %}"
            };


            $("#id_product_order").on("keyup", function (event) {
                event.preventDefault();
                event.stopPropagation();
                if (event.key === 'Enter') {

                    get_order_info();
                    event.stopPropagation();

                }
            });

            $("#id_purchase_no").on("keyup", function (event) {
                if (event.key === 'Enter') {
                    get_no_info();
                    event.stopPropagation();
                }
            });


            $(document).on("keydown", function (e) {
                if (e.which !== 27 && e.which !== 13) {
                    return;
                }

                if (e.which === 13) {
                    const cancelButton = $(".jsgrid-button.jsgrid-update-button");
                    if (cancelButton.length) {
                        cancelButton.click();

                    }
                } else if (e.which === 27) {
                    const updateButton = $(".jsgrid-button.jsgrid-cancel-edit-button");
                    if (updateButton.length) {
                        updateButton.click();

                    }
                }
                e.preventDefault();
                e.stopPropagation();
            });

            {# Search by Product Order, Purchase No #}
            $("#_product_order").on("click", function(event) {

                let product_order = $("#id_product_order").val().trim();

                if (!product_order) {
                    alert("{% trans 'Product Order cannot be null!' %}");

                } else {
                    get_order_info();
                }
                event.stopPropagation();


            });

            $("#_purchase_no").on("click", function(event) {

                let purchase_no = $("#id_purchase_no").val().trim();


                if (!purchase_no) {
                    alert("{% trans 'Purchase Order cannot be null!' %}");

                } else {
                    get_no_info();

                }
                event.stopPropagation();


            });

            const get_order_info = function() {

                let product_order = $("#id_product_order").val();

                $.ajax({
                    url: '{% url 'get_product_order_info' %}',
                    type: 'get',
                    dataType: 'json',
                    async: false,
                    data: {"product_order": product_order},
                    success: function(data) {
                        if (data.status === 'no_change'){
                            console.log("Keep the data table");
                        } else {
                            $("#jsGrid").jsGrid("option", "data", data);
                        }
                    },
                    error: function (xhr) {
                        const errorMsg = JSON.parse(xhr.responseText);
                        alert(errorMsg.message);
                    }
                });
            };

            const get_no_info = function() {

                let purchase_no = $("#id_purchase_no").val();

                $.ajax({
                    url: '{% url 'get_purchase_no_info' %}',
                    type: 'get',
                    dataType: 'json',
                    async: false,
                    data: {"purchase_no": purchase_no},
                    success: function(data) {
                        if (data.status === 'no_change'){
                            console.log("Keep the data table");
                        } else {
                            $("#jsGrid").jsGrid("option", "data", data);
                        }

                    },
                    error: function (xhr) {
                        const errorMsg = JSON.parse(xhr.responseText);
                        alert(errorMsg.message);
                    }
                });
            };

            $("#id_order_qty, #id_purchase_qty").on("input", function () {
                let value = $(this).val();

                value = value.replace(/[^0-9]/g, '');

                $(this).val(value);
            });


            {# Create new fields #}
            $("#create").on("click", function(event) {
                add_item();
                event.stopPropagation();
            });

            function add_item() {
                const order_qty =$("#id_order_qty").val();
                const order_bin =$("#id_order_bin").val();
                const desc =$("#id_desc").val();
                const product_order =$("#id_product_order").val();
                const version_no =$("#id_version_no").val();
                const lot_no =$("#id_lot_no").val();
                const item_type =$("#id_item_type option:selected").text();
                const item_type_val =$("#id_item_type").val();
                const purchase_no =$("#id_purchase_no").val();
                const purchase_qty =$("#id_purchase_qty").val();
                const size =$("#id_size").val();
                const purchase_unit =$("#id_purchase_unit").val();
                const post_date =$("#id_post_date").val();
                const supplier =$("#id_supplier").val();
                const sap_mtr_no =$("#id_sap_mtr_no").val();
                const customer_no =$("#id_customer_no").val();
                const version_seq = $("#id_version_seq").val();

                if(product_order == "" || purchase_no == "" || version_no == ""|| item_type_val == "") {
                    alert("({% trans "Product Order" %}/{% trans "Purchase Order" %}/{% trans "Version No" %}/{% trans "Item Type" %}) {% trans "are required" %}");
                    return false;
                } else {
                    $("#myForm input, #id_item_type, #id_desc, #id_purchase_unit").not("#id_post_date").val("");
                    $("#id_order_bin").val(null).trigger("change");
                    $("#id_purchase_qty, #id_order_qty").val(0);
                }

                const newItem = {
                    order_qty: order_qty,
                    order_bin: order_bin,
                    desc: desc,
                    customer_no: customer_no,
                    product_order: product_order,
                    version_no: version_no,
                    version_seq: version_seq,
                    lot_no: lot_no,
                    item_type: item_type,
                    purchase_no: purchase_no,
                    purchase_qty: purchase_qty,
                    size: size,
                    purchase_unit: purchase_unit,
                    post_date: post_date,
                    supplier: supplier,
                    sap_mtr_no: sap_mtr_no
                };

                // L·∫•y d·ªØ li·ªáu hi·ªán t·∫°i c·ªßa jsGrid
                let gridData = $("#jsGrid").jsGrid("option", "data");

                // Th√™m m·ª•c m·ªõi v√†o d·ªØ li·ªáu grid
                gridData.push(newItem);

                // C·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu cho jsGrid
                $("#jsGrid").jsGrid("option", "data", gridData);
                $("#jsGrid").jsGrid("refresh");
                $('html, body').animate({
                    scrollTop: $(document).height()
                }, 1000);

            }

            $("#deleteSelected").click(function (e) {
                const selectAll = $("#selectAll");
                const rowCheckbox = $(".rowCheckbox");

                if(selectAll.prop('checked') || rowCheckbox.is(':checked')){

                    let selectedItems = $("#jsGrid").jsGrid("option", "data").filter(item => item.selected);

                    // Xo√° c√°c item ƒë√£ ch·ªçn kh·ªèi b·∫£ng
                    selectedItems.forEach(item => {
                        $("#jsGrid").jsGrid("deleteItem", item);
                    });

                    $("#selectAll").prop("checked", false);
                } else {
                    const check_trans = "{% trans "The checkbox needs to be checked" %}!";
                    alert(check_trans);
                    return;
                }

                e.stopPropagation();

            });

            {# Main JsGrid #}
            data: []; // ÂàùÂßãÁÇ∫Á©∫ÔºåÂ∞áÈÄèÈÅé AJAX Âä†ËºâË≥áÊñô

            // ÂàùÂßãÂåñ jsGrid
            $("#jsGrid").jsGrid({
                width: "100%",
                height: "400px",
                autowidth: true,
                inserting: false,  // ÂïüÁî®Êñ∞Â¢ûÂäüËÉΩ
                editing: true,    // ÂïüÁî®Á∑®ËºØÂäüËÉΩ
                sorting: true,    // ÂïüÁî®ÊéíÂ∫èÂäüËÉΩ
                paging: true,     // ÂïüÁî®ÂàÜÈ†ÅÂäüËÉΩ
                {#data: #}
                noDataContent: "{% trans "Not found" %}",
                confirmDeleting: false,

                rowClick: function (args) {

                    {#console.log(args);#}

                    if ($(args.event.target).closest("td").index() <= 2) {
                        return;
                    }
                    this.editItem(args.item);

                    let $row = $(".jsgrid-edit-row");
                    let checkbox = $row.find("input.rowCheckbox");

                    checkbox.hide();
                },

                data: [],   // Â∞á JSON Ë≥áÊñôÂ∞éÂÖ•Ë°®Ê†º

                fields: [
                    {
                        name: "selected",
                        title: "",
                        align: "center",
                        width: 50,
                        filtering: false,
                        sorting: false,
                        editing: false,
                        headerTemplate: function() {
                            const checkbox = $("<input>")
                                .attr("type", "checkbox")
                                .attr("id", "selectAll");

                            checkbox.on("change", function() {
                                const checked = $(this).is(":checked");
                                const data = $("#jsGrid").jsGrid("option", "data");

                                data.forEach(item => {
                                    item.selected = checked;
                                });

                                // c·∫≠p nh·∫≠t l·∫°i jsGrid ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng tr·∫°ng th√°i checkbox
                                $("#jsGrid").jsGrid("refresh");
                            });

                            return checkbox;
                        },
                        itemTemplate: function(value, item) {
                            return $("<input>")
                                .attr("type", "checkbox")
                                .attr("class", "rowCheckbox")
                                .prop("checked", value)
                                .on("change", function() {
                                    item.selected = $(this).is(":checked");
                                });
                        },

                    },
                    {
                        name: "copy", // Ëá™ÂÆöÁæ©ÊéßÂà∂Ê¨ÑÊ¨Ñ‰ΩçÂêçÁ®±
                        title: "", // Ê¨Ñ‰ΩçÊ®ôÈ°å
                        align: "center", // ÁΩÆ‰∏≠Â∞çÈΩä
                        itemTemplate: function (_, item) {
                            // Ëá™ÂÆöÁæ©„ÄåË§áË£Ω„ÄçÊåâÈàï
                            const $copyButton = $("<button>")
                                .text("{% trans "Copy" %}")
                                .addClass("btn btn-info btn-sm")
                                .on("click", (e) => {

                                    const gridData = $("#jsGrid").jsGrid("option", "data");
                                    const index = gridData.indexOf(item);

                                    // Ë§áË£ΩË°å‰∏¶‰øÆÊîπÂÖßÂÆπ
                                    const newItem = { ...item };
                                    newItem.id = Date.now(); // Êñ∞ÁöÑÂîØ‰∏Ä ID
                                    newItem.order_bin = "";
                                    newItem.order_qty = "";

                                    // ÊèíÂÖ•Âà∞Áï∂ÂâçË°åÁöÑ‰∏ãÊñπ
                                    gridData.splice(index + 1, 0, newItem);

                                    // ÈáçÊñ∞ËºâÂÖ•Êï∏Êìö
                                    $("#jsGrid").jsGrid("option", "data", gridData);

                                    alert("{% trans "Copy and insert below this row Success!" %}");
                                });


                            return $copyButton;
                        }
                    },
                    {
                        type: "control",
                        width: 80,
                        itemTemplate: function(_, item) {
                            // Âª∫Á´ãÂà™Èô§ÊåâÈàï
                            const deleteButton = $("<button>")
                                .addClass("btn btn-warning btn-sm") // Bootstrap Ê®£ÂºèÔºàÂèØÈÅ∏Ôºâ
                                .text("{% trans "Delete" %}")
                                .on("click", function(e) {
                                    $("#jsGrid").jsGrid("deleteItem", item);
                                    e.stopPropagation(); // Èò≤Ê≠¢Ëß∏ÁôºË°åÈªûÊìä‰∫ã‰ª∂
                                });

                            return deleteButton;
                        }
                    },
                    { name: "id", type: "number", width: 50, title: "ID", readOnly: true, visible: false },
                    { name: "customer_no", type: "text", width: 150, title: translations.customerNo, editing: true, css: "text-center" },
                    { name: "product_order", type: "text", width: 135, title: translations.productOrder, validate: "required", editing: false, css: "text-center" },
                    { name: "version_no", type: "text", width: 120, title: translations.versionNo, validate: "required", editing: false, css: "text-center" },
                    { name: "lot_no", type: "text", width: 130, title: translations.lotNo, editing: true, css: "text-center" },
                    { name: "size", type: "text", width: 70, title: translations.size, validate: "required", editing: true, css: "text-center" },
                    {
                        name: "order_qty",
                        type: "number",
                        width: 125,
                        title: translations.qty,
                        validate: {
                            message: "S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0!",
                            validator: function(value) {
                                return Number(value) > 0;
                            }
                        }
                    },
                    { name: "item_type", type: "text", width: 200, title: translations.itemType, editing: false, css: "text-center" },
                    {
                        name: "order_bin",
                        type: "text",
                        width: 170,
                        title: "{% trans "Location" %}",
                        css: "text-center",
                        itemTemplate: function (value) {
                            return value; // Hi·ªÉn th·ªã n·ªôi dung
                        },
                        editTemplate: function (value, item) {

                            const $input = $("<input>").val(value).addClass("form-control input-custom").css({
                                                "padding-right": "1px"
                                           });

                            const $button = $("<button>", {type: "button"})
                                           .addClass("btn btn-primary")
                                           .css({
                                               width: "auto",
                                               height: "40px",
                                               marginLeft: "20px"
                                           });

                            const $container = $("<div>").css({
                                                "--bs-gutter-x": "0", "display": "flex", "flex-wrap": "wrap"
                                            })
                                           .append($("<div>")
                                           .css({
                                               "width": "100px"
                                           })
                                           .append($input))
                                           .append($button); // Button chi·∫øm col-2

                            // pass this data to jsgrid
                            this._input = $input;

                            $button.on("click", function () {
                                obj = $input;
                                openMapPage('PKG', obj);

                            });

                            return $container;
                        },
                        insertValue: function () {
                            return this._input.val(); // Tr·∫£ v·ªÅ gi√° tr·ªã khi ch√®n
                        },
                        editValue: function () {
                            return this._input.val(); // Tr·∫£ v·ªÅ gi√° tr·ªã khi ch·ªânh s·ª≠a
                        }
                    },
                    { name: "desc", type: "text", width: 225, title: translations.comment,editing: true, css: "text-center" },
                    { name: "purchase_qty", type: "number", width: 120, title: translations.purchaseQty, editing: false },
                    { name: "supplier", type: "text", width: 130, title: translations.supplier, editing: true, css: "text-center" },
                    { name: "post_date", type: "date", width: 150, title: translations.postDate, editing: false, css: "text-center" },
                    { name: "purchase_unit", type: "text", width: 130, title: translations.purchaseUnit, editing: false, css: "text-center" },
                    { name: "sap_mtr_no", type: "text", width: 120, title: translations.sapMtrNo, editing: false, css: "text-center" },
                    { name: "version_seq", type: "text", width: 120, title: translations.versionSeq, validate: "required", editing: false, css: "text-center" },
                    { name: "purchase_no", type: "text", width: 125, title: translations.purchaseNo, validate: "required", editing: false, css: "text-center" },
                ],
                onRefreshed: function() {
                    const selectAll = document.getElementById("selectAll");
                    const rowCheckboxes = document.querySelectorAll(".rowCheckbox");

                    // X·ª≠ l√Ω selectAll
                    if (selectAll) {
                        selectAll.addEventListener("change", function () {
                            rowCheckboxes.forEach(cb => cb.checked = selectAll.checked);
                        });
                    }

                    // X·ª≠ l√Ω khi b·ªè ch·ªçn 1 checkbox d√≤ng
                    rowCheckboxes.forEach(cb => {
                        cb.addEventListener("change", function () {
                            const allChecked = Array.from(rowCheckboxes).every(c => c.checked);
                            if (selectAll) selectAll.checked = allChecked;
                        });
                    });
                }
            });


            $(".zone").on("click", function(event) {

                let bin_id = $(this).data("value");
                const updateInput = $("#zonePopup").data("updateInput"); // ÂèñÂæóÂõûË™øÂáΩÊï∏

                if (updateInput) {
                    updateInput(bin_id); // Êõ¥Êñ∞Ëº∏ÂÖ•Ê°ÜÁöÑÂÄº
                }

                $("#zonePopup").fadeOut();
                event.stopPropagation();
            });


            // ÈóúÈñâÂΩàÁ™ó
            $("#closePopup").on("click", function (event) {
                $("#zonePopup").fadeOut();
                event.stopPropagation();
            });


            // Áï∂Êåâ‰∏ãÈÅéÂ∏≥ÊåâÈàïÊôÇ
            $('#postDataButton').click(function(event) {
                event.preventDefault();
                // Áç≤Âèñ jsGrid ÁöÑÊâÄÊúâÊï∏Êìö
                let gridData = $("#jsGrid").data("JSGrid").data;

                if (!gridData || gridData.length === 0) {
                    alert("{% trans "No data in the table! Please enter at least one row." %}");
                    event.stopPropagation();
                    return;
                }

                for (let i = 0; i < gridData.length; i++) {
                    let orderBin = gridData[i].order_bin;
                    let orderQty = gridData[i].order_qty;

                    if (!orderBin || String(orderBin).trim() === "") {
                        alert({% blocktrans %}"(Location) field in row " + (i + 1) + " cannot be empty!"{% endblocktrans %});
                        return;
                    }

                    if (orderQty === null || orderQty === undefined || String(orderQty).trim() === "") {
                        alert({% blocktrans %}"(Order Quantity) field in row " + (i + 1) + " cannot be empty!"{% endblocktrans %});
                        return;
                    }
                }

                // Â∞áÊï∏ÊìöËΩâÊèõÁÇ∫ JSON Ê†ºÂºè
                let jsonData = JSON.stringify(gridData);

                // ‰ΩøÁî® Ajax ÁôºÈÄÅÊï∏ÊìöÂà∞ÂæåÁ´Ø
                $.ajax({
                    url: '{% url 'packing_material_stock_in_post' %}',  // Ë®≠ÁΩÆÂæåÁ´ØÊé•Êî∂Êï∏ÊìöÁöÑ URL
                    type: 'POST',
                    contentType: 'application/json',
                    data: jsonData,
                    success: function(response) {

                        //Reset all input
                        $("#myForm")[0].reset();

                        $("#jsGrid").jsGrid("option", "data", []);
                        $("#jsGrid").jsGrid("refresh");


                        alert("{% trans "Form submitted successfully!" %}");
                        console.log(response);
                    },
                    error: function(xhr) {
                        const errorMsg = JSON.parse(xhr.responseText);
                        if (errorMsg.status === "error") {
                            alert(errorMsg.message); // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói t·ª´ server
                        } else {
                            alert("An unknown error occurred.");
                        }
                    }
                });

                event.stopPropagation();

            });

        });

    </script>
{% endblock %}